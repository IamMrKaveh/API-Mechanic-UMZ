import{a as E}from"./chunk-A4FOPVB5.js";import"./chunk-T5TNNXDL.js";import{i as v,x as g,z as x}from"./chunk-2CT2PKNK.js";import{Ab as d,Bb as h,Ca as l,Sa as m,X as u,eb as c,fb as f,kb as o,lb as s,mb as p,tb as y}from"./chunk-6VZDFBBI.js";import"./chunk-4CLCTAJ7.js";function S(a,n){if(a&1&&(o(0,"p",5),d(1),s()),a&2){let C=y();l(),h(C.errorMessage)}}var q=(()=>{let n=class n{constructor(){this.route=u(g),this.router=u(x),this.orderService=u(E),this.errorMessage=null}ngOnInit(){let t=this.route.snapshot.queryParamMap,e=t.get("Authority")||t.get("authority"),i=t.get("Status")||t.get("status"),r=t.get("orderId");if(!e||!r){console.error("[PaymentCallback] Missing params",{authority:e,orderIdStr:r}),this.handleFailure(r,"invalid_params");return}let b=parseInt(r,10);this.verifyPayment(e,i||"NOK",b)}verifyPayment(t,e,i){this.orderService.verifyPayment(t,e,i).subscribe({next:r=>{r.isVerified?this.router.navigate(["/payment/success"],{queryParams:{orderId:i,refId:r.refId},replaceUrl:!0}):this.handleFailure(i.toString(),this.mapErrorReason(r.message))},error:r=>{console.error("[PaymentCallback] Verify Error:",r),this.handleFailure(i.toString(),"server_error")}})}handleFailure(t,e){this.router.navigate(["/payment/failure"],{queryParams:{orderId:t,reason:e},replaceUrl:!0})}mapErrorReason(t){if(!t)return"verification_failed";let e=t.toLowerCase();return e.includes("cancel")||e.includes("\u0644\u063A\u0648")||e.includes("nok")?"payment_cancelled":e.includes("not found")||e.includes("\u06CC\u0627\u0641\u062A \u0646\u0634\u062F")?"order_not_found":e.includes("amount")||e.includes("\u0645\u0628\u0644\u063A")?"amount_mismatch":e.includes("already verified")||e.includes("\u0642\u0628\u0644\u0627 \u062A\u0627\u06CC\u06CC\u062F \u0634\u062F\u0647")?"already_verified":"verification_failed"}};n.\u0275fac=function(e){return new(e||n)},n.\u0275cmp=m({type:n,selectors:[["app-payment-callback"]],decls:8,vars:1,consts:[[1,"min-h-screen","flex","items-center","justify-center","bg-gray-50"],[1,"text-center","p-8"],[1,"animate-spin","rounded-full","h-16","w-16","border-b-2","border-primary","mx-auto","mb-4"],[1,"text-xl","font-semibold","text-gray-700","mb-2"],[1,"text-gray-500"],[1,"text-red-500","mt-4"]],template:function(e,i){e&1&&(o(0,"div",0)(1,"div",1),p(2,"div",2),o(3,"h2",3),d(4,"\u062F\u0631 \u062D\u0627\u0644 \u0628\u0631\u0631\u0633\u06CC \u067E\u0631\u062F\u0627\u062E\u062A"),s(),o(5,"p",4),d(6,"\u0644\u0637\u0641\u0627\u064B \u0635\u0628\u0631 \u06A9\u0646\u06CC\u062F"),s(),c(7,S,2,1,"p",5),s()()),e&2&&(l(7),f(i.errorMessage?7:-1))},dependencies:[v],encapsulation:2});let a=n;return a})();export{q as PaymentCallback};
