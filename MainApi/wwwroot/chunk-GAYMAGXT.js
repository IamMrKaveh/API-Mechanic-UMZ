import{b as E}from"./chunk-KL5Q5BU5.js";import{a as m}from"./chunk-WNMS36QR.js";import{h as o,o as p,y as g}from"./chunk-PMZJQWMM.js";import{O as l,T as h,X as s,e as n,i,m as f,y as a,ya as c}from"./chunk-OU7FPMWK.js";var Y=(()=>{class r{static{this.TOKEN_KEY="auth_token"}static{this.REFRESH_TOKEN_KEY="refresh_token"}static{this.USER_PROFILE_KEY="user_profile"}constructor(t,e,S,I){this.http=t,this.router=e,this.platformId=S,this.cartService=I,this.apiUrl=`${m.API_URL}auth`;let u=this.getUserFromStorage();this.userProfileSubject=new n(u),this.isLoggedInSubject=new n(!!u&&!!r.getAuthToken()),this.userProfile$=this.userProfileSubject.asObservable(),this.isLoggedIn$=this.isLoggedInSubject.asObservable()}static getAuthToken(){return typeof window<"u"?localStorage.getItem(r.TOKEN_KEY):null}static getRefreshToken(){return typeof window<"u"?localStorage.getItem(r.REFRESH_TOKEN_KEY):null}get currentUserValue(){return this.userProfileSubject.value}isAuthenticated(){return this.isLoggedInSubject.value}isUserAdmin(){return this.currentUserValue?.isAdmin??!1}login(t){return this.http.post(`${this.apiUrl}/request-otp`,t)}requestOtp(t){return this.http.post(`${this.apiUrl}/request-otp`,t)}verifyOtp(t){return this.http.post(`${this.apiUrl}/verify-otp`,t).pipe(l(e=>{e&&e.user&&e.token&&(this.cartService.removeGuestToken(),this.setSession(e))}))}setSession(t){o(this.platformId)&&(localStorage.setItem(r.TOKEN_KEY,t.token),localStorage.setItem(r.REFRESH_TOKEN_KEY,t.refreshToken),localStorage.setItem(r.USER_PROFILE_KEY,JSON.stringify(t.user))),this.userProfileSubject.next(t.user),this.isLoggedInSubject.next(!0)}updateUserProfile(t){o(this.platformId)&&localStorage.setItem(r.USER_PROFILE_KEY,JSON.stringify(t)),this.userProfileSubject.next(t)}logout(t=!0){let e=r.getRefreshToken();e?this.http.post(`${this.apiUrl}/logout`,{refreshToken:e}).subscribe({next:()=>this.handleLogoutSuccess(t),error:()=>this.handleLogoutSuccess(t)}):this.handleLogoutSuccess(t)}logoutAll(){return this.http.post(`${this.apiUrl}/logout-all`,{}).pipe(l(()=>this.clearLocalSession()),a(t=>(this.clearLocalSession(),i(()=>t))))}handleLogoutSuccess(t){this.clearLocalSession(),t&&this.router.navigate(["/auth"])}clearLocalSession(){o(this.platformId)&&(localStorage.removeItem(r.TOKEN_KEY),localStorage.removeItem(r.REFRESH_TOKEN_KEY),localStorage.removeItem(r.USER_PROFILE_KEY)),this.isLoggedInSubject.next(!1),this.userProfileSubject.next(null)}refreshToken(){let t=r.getRefreshToken();return t?this.http.post(`${this.apiUrl}/refresh-token`,{refreshToken:t}).pipe(f(e=>(e&&e.token&&(this.updateToken(e.token),e.refreshToken&&this.updateRefreshToken(e.refreshToken)),e)),a(e=>(this.logout(!1),i(()=>e)))):(this.logout(!1),i(()=>new Error("No refresh token available")))}updateToken(t){o(this.platformId)&&localStorage.setItem(r.TOKEN_KEY,t)}updateRefreshToken(t){o(this.platformId)&&localStorage.setItem(r.REFRESH_TOKEN_KEY,t)}getUserFromStorage(){if(o(this.platformId)){let t=localStorage.getItem(r.USER_PROFILE_KEY);if(t)try{return JSON.parse(t)}catch(e){return this.clearLocalSession(),null}}return null}static{this.\u0275fac=function(e){return new(e||r)(s(p),s(g),s(c),s(E))}}static{this.\u0275prov=h({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();export{Y as a};
