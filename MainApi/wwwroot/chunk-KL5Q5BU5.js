import{a as M}from"./chunk-NKWORGOE.js";import{a as $}from"./chunk-WNMS36QR.js";import{h as R,o as j}from"./chunk-PMZJQWMM.js";import{H as S,O as m,T as E,X as f,e as I,h as c,i as l,o as d,u as v,y as p,ya as T}from"./chunk-OU7FPMWK.js";import{a as U,b}from"./chunk-4CLCTAJ7.js";var a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));function V(e,i=0){return(a[e[i+0]]+a[e[i+1]]+a[e[i+2]]+a[e[i+3]]+"-"+a[e[i+4]]+a[e[i+5]]+"-"+a[e[i+6]]+a[e[i+7]]+"-"+a[e[i+8]]+a[e[i+9]]+"-"+a[e[i+10]]+a[e[i+11]]+a[e[i+12]]+a[e[i+13]]+a[e[i+14]]+a[e[i+15]]).toLowerCase()}var y,D=new Uint8Array(16);function C(){if(!y){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");y=crypto.getRandomValues.bind(crypto)}return y(D)}var K=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),x={randomUUID:K};function N(e,i,t){e=e||{};let r=e.random??e.rng?.()??C();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,i){if(t=t||0,t<0||t+16>i.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let o=0;o<16;++o)i[t+o]=r[o];return i}return V(r)}function P(e,i,t){return x.randomUUID&&!i&&!e?x.randomUUID():N(e,i,t)}var w=P;var it=(()=>{class e{static{this.GUEST_TOKEN_KEY="guest_token"}static{this.MAX_RETRIES=3}constructor(t,r,o){this.http=t,this.notificationService=r,this.platformId=o,this.cartsUrl=`${$.API_URL}Cart`,this.cartSubject=new I(null),this.cart$=this.cartSubject.asObservable(),this.cartItemCountSubject=new I(0),this.cartItemCount$=this.cartItemCountSubject.asObservable()}static getGuestToken(){if(typeof window<"u"){let t=localStorage.getItem(e.GUEST_TOKEN_KEY);return t||(t=w(),localStorage.setItem(e.GUEST_TOKEN_KEY,t)),t}return null}removeGuestToken(){R(this.platformId)&&localStorage.removeItem(e.GUEST_TOKEN_KEY)}get currentCartValue(){return this.cartSubject.value}getMyCart(){return this.http.get(this.cartsUrl).pipe(m(t=>this.updateCartState(t)),p(()=>(this.updateCartState(null),c(null))))}addToCart(t,r,o,n){e.getGuestToken();let s;return typeof t=="object"?s=t:s={variantId:t,quantity:r,variantRowVersion:o,cartItemRowVersion:n},this.http.post(`${this.cartsUrl}/items`,s).pipe(m(u=>{this.updateCartState(u),this.notificationService.show("\u0645\u062D\u0635\u0648\u0644 \u0628\u0647 \u0633\u0628\u062F \u062E\u0631\u06CC\u062F \u0627\u0636\u0627\u0641\u0647 \u0634\u062F","success")}),p(u=>{let h=u?.error?.message||"\u062E\u0637\u0627 \u062F\u0631 \u0627\u0641\u0632\u0648\u062F\u0646 \u0628\u0647 \u0633\u0628\u062F \u062E\u0631\u06CC\u062F";return this.notificationService.show(h,"error"),c(null)}))}addItem(t,r,o,n){return this.addToCart(t,r,o,n)}updateItem(t,r,o){return this.updateCartItemWithRetry(t,{quantity:r,rowVersion:o})}updateCartItemWithRetry(t,r){return this.http.put(`${this.cartsUrl}/items/${t}`,r).pipe(S(o=>o.pipe(d((n,s)=>n.status===409&&s<e.MAX_RETRIES?this.getMyCart().pipe(d(u=>{if(!u)return l(()=>n);let h=u.cartItems.find(g=>g.id===t);if(h){let g=b(U({},r),{rowVersion:h.rowVersion});return v(500).pipe(d(()=>l(()=>({retry:!0,payload:g}))))}return l(()=>n)})):l(()=>n)))),m(o=>this.updateCartState(o)),p(o=>(o.status===409?(this.notificationService.show("\u0645\u062D\u0635\u0648\u0644 \u062A\u0648\u0633\u0637 \u06A9\u0627\u0631\u0628\u0631 \u062F\u06CC\u06AF\u0631\u06CC \u062A\u063A\u06CC\u06CC\u0631 \u06A9\u0631\u062F\u0647 \u0627\u0633\u062A. \u0644\u0637\u0641\u0627\u064B \u0645\u062C\u062F\u062F\u0627\u064B \u062A\u0644\u0627\u0634 \u06A9\u0646\u06CC\u062F.","info"),this.getMyCart().subscribe()):this.notificationService.show(o?.error?.message||"\u062E\u0637\u0627 \u062F\u0631 \u0648\u06CC\u0631\u0627\u06CC\u0634 \u0633\u0628\u062F \u062E\u0631\u06CC\u062F","error"),c(null))))}updateCartItem(t,r){return this.updateCartItemWithRetry(t,r)}removeItem(t){return this.removeFromCart(t)}removeFromCart(t,r){let o=r?`${this.cartsUrl}/items/${t}?rowVersion=${encodeURIComponent(r)}`:`${this.cartsUrl}/items/${t}`;return this.http.delete(o).pipe(S(n=>n.pipe(d((s,u)=>s.status===409&&u<e.MAX_RETRIES?this.getMyCart().pipe(d(()=>v(500))):l(()=>s)))),m(n=>{this.updateCartState(n),this.notificationService.show("\u0645\u062D\u0635\u0648\u0644 \u0627\u0632 \u0633\u0628\u062F \u062E\u0631\u06CC\u062F \u062D\u0630\u0641 \u0634\u062F","success")}),p(n=>(n.status===409?(this.notificationService.show("\u0645\u062D\u0635\u0648\u0644 \u062A\u0648\u0633\u0637 \u06A9\u0627\u0631\u0628\u0631 \u062F\u06CC\u06AF\u0631\u06CC \u062A\u063A\u06CC\u06CC\u0631 \u06A9\u0631\u062F\u0647 \u0627\u0633\u062A.","info"),this.getMyCart().subscribe()):this.notificationService.show("\u062E\u0637\u0627 \u062F\u0631 \u062D\u0630\u0641 \u0645\u062D\u0635\u0648\u0644","error"),c(null))))}clearCart(){return this.http.delete(`${this.cartsUrl}/clear`).pipe(m(()=>{this.updateCartState(null),this.notificationService.show("\u0633\u0628\u062F \u062E\u0631\u06CC\u062F \u062E\u0627\u0644\u06CC \u0634\u062F","success")}),p(()=>(this.notificationService.show("\u062E\u0637\u0627 \u062F\u0631 \u062E\u0627\u0644\u06CC \u06A9\u0631\u062F\u0646 \u0633\u0628\u062F \u062E\u0631\u06CC\u062F","error"),c(void 0))))}getCartItemsCount(){return this.http.get(`${this.cartsUrl}/items/count`).pipe(m(t=>this.cartItemCountSubject.next(t)),p(()=>c(0)))}clearLocalCart(){this.cartSubject.next(null),this.cartItemCountSubject.next(0)}updateCartState(t){this.cartSubject.next(t);let r=t?.cartItems?.reduce((o,n)=>o+n.quantity,0)??0;this.cartItemCountSubject.next(r)}checkPriceChanges(t){return t.priceChanges&&t.priceChanges.length>0}getPriceChangesSummary(t){return!t.priceChanges||t.priceChanges.length===0?[]:t.priceChanges.map(r=>{let n=t.cartItems.find(h=>h.variantId===r.variantId)?.productName||"\u0645\u062D\u0635\u0648\u0644",s=r.newPrice-r.oldPrice,u=s>0?"\u0627\u0641\u0632\u0627\u06CC\u0634":"\u06A9\u0627\u0647\u0634";return`${n}: ${u} ${Math.abs(s).toLocaleString()} \u062A\u0648\u0645\u0627\u0646`})}static{this.\u0275fac=function(r){return new(r||e)(f(j),f(M),f(T))}}static{this.\u0275prov=E({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();export{w as a,it as b};
