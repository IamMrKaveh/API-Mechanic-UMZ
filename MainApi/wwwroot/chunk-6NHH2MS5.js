import{b as p}from"./chunk-H442PVK2.js";import{a as S}from"./chunk-ISFWZGBK.js";import{j as i,q as m,z as E}from"./chunk-QOTKPPKC.js";import{N as c,S as f,W as o,g as n,k as a,n as u,ua as g,z as h}from"./chunk-6VZDFBBI.js";var F=(()=>{let e=class e{constructor(t,r,I,d){this.http=t,this.router=r,this.platformId=I,this.cartService=d,this.apiUrl=`${S.API_URL}Users`;let l=this.getUserFromStorage();this.userProfileSubject=new n(l),this.isLoggedInSubject=new n(!!l&&!!e.getAuthToken()),this.userProfile$=this.userProfileSubject.asObservable(),this.isLoggedIn$=this.isLoggedInSubject.asObservable()}static getAuthToken(){return typeof window<"u"?localStorage.getItem(e.TOKEN_KEY):null}static getRefreshToken(){return typeof window<"u"?localStorage.getItem(e.REFRESH_TOKEN_KEY):null}get currentUserValue(){return this.userProfileSubject.value}isAuthenticated(){return this.isLoggedInSubject.value}isUserAdmin(){return this.currentUserValue?.isAdmin??!1}login(t){return this.http.post(`${this.apiUrl}/login`,t)}verifyOtp(t){return this.http.post(`${this.apiUrl}/verify-otp`,t).pipe(c(r=>{r&&r.user&&r.token&&(this.setSession(r),this.cartService.removeGuestToken())}))}setSession(t){i(this.platformId)&&(localStorage.setItem(e.TOKEN_KEY,t.token),localStorage.setItem(e.REFRESH_TOKEN_KEY,t.refreshToken),localStorage.setItem(e.USER_PROFILE_KEY,JSON.stringify(t.user))),this.userProfileSubject.next(t.user),this.isLoggedInSubject.next(!0)}updateUserProfile(t){i(this.platformId)&&localStorage.setItem(e.USER_PROFILE_KEY,JSON.stringify(t)),this.userProfileSubject.next(t)}logout(t=!0){let r=e.getRefreshToken();r?this.http.post(`${this.apiUrl}/logout`,{refreshToken:r}).subscribe({next:()=>this.handleLogoutSuccess(t),error:()=>this.handleLogoutSuccess(t)}):this.handleLogoutSuccess(t)}handleLogoutSuccess(t){this.clearLocalSession(),t&&this.router.navigate(["/auth"])}clearLocalSession(){i(this.platformId)&&(localStorage.removeItem(e.TOKEN_KEY),localStorage.removeItem(e.REFRESH_TOKEN_KEY),localStorage.removeItem(e.USER_PROFILE_KEY)),this.isLoggedInSubject.next(!1),this.userProfileSubject.next(null)}refreshToken(){let t=e.getRefreshToken();return t?this.http.post(`${this.apiUrl}/refresh`,{refreshToken:t}).pipe(u(r=>(r&&r.token&&(this.updateToken(r.token),r.refreshToken&&this.updateRefreshToken(r.refreshToken)),r)),h(r=>(this.logout(!1),a(()=>r)))):(this.logout(!1),a(()=>new Error("No refresh token available")))}updateToken(t){i(this.platformId)&&localStorage.setItem(e.TOKEN_KEY,t)}updateRefreshToken(t){i(this.platformId)&&localStorage.setItem(e.REFRESH_TOKEN_KEY,t)}getUserFromStorage(){if(i(this.platformId)){let t=localStorage.getItem(e.USER_PROFILE_KEY);if(t)try{return JSON.parse(t)}catch{return this.clearLocalSession(),null}}return null}};e.TOKEN_KEY="auth_token",e.REFRESH_TOKEN_KEY="refresh_token",e.USER_PROFILE_KEY="user_profile",e.\u0275fac=function(r){return new(r||e)(o(m),o(E),o(g),o(p))},e.\u0275prov=f({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})();export{F as a};
